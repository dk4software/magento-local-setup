#!/bin/bash
set -o errexit

echo "Setting up local magento"

source mftf/env/.env.sample

# install sample data
echo "Install sample data"

bin/clinotty bin/magento sampledata:deploy

bin/clinotty bin/magento module:enable --all #sometimes sample data modules don't get enabled.

echo "Building Magento"

bin/clinotty bin/magento setup:upgrade

bin/clinotty bin/magento config:set twofactorauth/general/enable 0

bin/clinotty bin/magento setup:upgrade \
 && bin/clinotty bin/magento setup:di:compile \
 && bin/clinotty bin/magento setup:static-content:deploy -f \
 && bin/clinotty bin/magento indexer:reindex \
 && bin/clinotty bin/magento cache:flush \
 && bin/clinotty bin/magento cache:clean


#prompt to create admin user and delete the default one.
read -r -n 1 -p "Create admin acccount? (y/n). This will delete the default one." CREATE_ADMIN

echo #new line

if [ -n "$CREATE_ADMIN" ] && [ "${CREATE_ADMIN^}" == "Y" ]; then

    bin/magento admin:user:create

    #delete the default user john.smith (to avoid security issue)
    echo "delete from admin_user where user_id = 1" | bin/mysql
fi
